{% extends 'base.html' %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}


{% block content %}
<main id="content" class="relative flex-1 flex flex-col items-center overflow-y-auto w-full">
    <div class="w-full flex flex-col lg:flex-row gap-6 p-4">
        <!-- Video Section (Left) -->
        <div class="flex-1 flex flex-col min-w-0">
            <div class="w-full rounded-xl overflow-hidden shadow-lg bg-black relative pt-[56.25%]">
                <video class="absolute top-0 left-0 w-full h-full object-contain" controls>
                    <source src="{{ url_for('media_file', filename='outputs/' + 'output_' + taskID + '.mp4') }}"
                        type="video/mp4">
                </video>
            </div>
        </div>

        <!-- Analytics/Toolbar Section (Right) -->
        <div class="w-full lg:w-96 flex-shrink-0 flex flex-col gap-4">
            <div class="w-full bg-secondary-bg rounded-xl p-4 shadow-sm border border-primary-border">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-text-color font-semibold text-lg">Analytics</h3>
                </div>
                <!-- Fixed height chart container -->
                <div class="w-full h-64">
                    <canvas id="analyticsChart"></canvas>
                </div>

                <div class="pt-2 mt-2 border-t border-primary-border">
                    <a href="{{ url_for('export_csv', task_id=taskID) }}"
                        class="btn-primary w-full flex items-center justify-center gap-2 hover:bg-hover-btn py-2 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" x2="12" y1="15" y2="3" />
                        </svg>
                        Download CSV
                    </a>
                </div>
            </div>

            <!-- Metadata moved to sidebar/toolbar as commonly seen in video platforms -->
            <div
                class="w-full bg-secondary-bg rounded-xl p-4 shadow-sm border border-primary-border flex flex-col gap-2 text-sm text-secondary-text flex-1">
                <h3 class="text-text-color font-semibold text-lg mb-2">Details</h3>
                <p class="flex justify-between">
                    <span>Width:</span>
                    <span class="value text-text-color">{{ width }} px</span>
                </p>
                <p class="flex justify-between">
                    <span>Height:</span>
                    <span class="value text-text-color">{{ height }} px</span>
                </p>
                <p class="flex justify-between">
                    <span>Process Time:</span>
                    <span class="value text-text-color">{{ process_time }} s</span>
                </p>

            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script id="detection-data" type="application/json">
    {{ detection_data | tojson }}
</script>
<script id="zones-data" type="application/json">
    {{ zones | tojson }}
</script>
<script>
    const detectionData = JSON.parse(document.getElementById('detection-data').textContent);
    const zonesData = JSON.parse(document.getElementById('zones-data').textContent) || [];

    // HSL to RGB helper (matches zone.js)
    function hslToRgb(h, s, l) {
        s /= 100;
        l /= 100;
        const k = n => (n + h / 30) % 12;
        const a = s * Math.min(l, 1 - l);
        const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
        return [Math.round(255 * f(0)), Math.round(255 * f(8)), Math.round(255 * f(4))];
    }

    function getColorFromClassId(classId) {
        const hue = (classId * 137.508) % 360;
        return hslToRgb(hue, 85, 55);
    }

    if (detectionData && detectionData.length > 0) {
        const ctx = document.getElementById('analyticsChart').getContext('2d');

        // Group detection events by zone
        const zoneEvents = {};
        const allTimes = new Set();

        detectionData.forEach(d => {
            const zoneId = d.zone_id || 'default';
            if (!zoneEvents[zoneId]) {
                zoneEvents[zoneId] = {};
            }
            zoneEvents[zoneId][d.time] = d.count;
            allTimes.add(d.time);
        });

        // Sort times for x-axis
        const labels = Array.from(allTimes).sort((a, b) => a - b);

        // Create datasets for each zone
        const datasets = [];
        const zoneIds = Object.keys(zoneEvents);

        zoneIds.forEach((zoneId, idx) => {
            // Find zone info to get color
            const zone = zonesData.find(z => z.id === zoneId);
            let color;

            if (zone && zone.color) {
                color = `rgb(${zone.color[0]}, ${zone.color[1]}, ${zone.color[2]})`;
            } else if (zone && zone.classId) {
                const [r, g, b] = getColorFromClassId(zone.classId);
                color = `rgb(${r}, ${g}, ${b})`;
            } else {
                // Fallback colors
                const fallbackColors = ['#1F6F65', '#F59E0B', '#EF4444', '#8B5CF6', '#10B981'];
                color = fallbackColors[idx % fallbackColors.length];
            }

            // Build data array with cumulative counts
            let lastCount = 0;
            const data = labels.map(time => {
                if (zoneEvents[zoneId][time] !== undefined) {
                    lastCount = zoneEvents[zoneId][time];
                }
                return lastCount;
            });

            datasets.push({
                label: `Zone ${idx + 1}`,
                data: data,
                borderColor: color,
                backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 4,
                fill: true,
                tension: 0.4
            });
        });

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
                plugins: {
                    legend: {
                        display: datasets.length > 1,
                        position: 'top',
                        labels: {
                            color: '#9ca3af',
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        titleColor: '#f3f4f6',
                        bodyColor: '#d1d5db',
                        padding: 10,
                        displayColors: true,
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false,
                            color: '#374151'
                        },
                        ticks: {
                            color: '#9ca3af',
                            maxTicksLimit: 10
                        },
                        title: {
                            display: true,
                            text: 'Time (s)',
                            color: '#6b7280'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(55, 65, 81, 0.5)'
                        },
                        ticks: {
                            color: '#9ca3af',
                            precision: 0
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }
</script>
<script src="{{url_for('static', filename='js/result.js')}}"></script>
{% endblock %}
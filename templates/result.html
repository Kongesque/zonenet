{% extends 'base.html' %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
{% endblock %}


{% block content %}
<main id="content" class="relative flex-1 flex flex-col items-center overflow-y-auto w-full">
    <div class="w-full flex flex-col lg:flex-row gap-6 p-4">
        <!-- Video Section (Left) -->
        <div class="flex-1 flex flex-col min-w-0">
            <div class="w-full rounded-xl overflow-hidden shadow-lg bg-black relative pt-[56.25%]">
                <video class="absolute top-0 left-0 w-full h-full object-contain" controls>
                    <source src="{{ url_for('media_file', filename='outputs/' + 'output_' + taskID + '.mp4') }}"
                        type="video/mp4">
                </video>
            </div>
        </div>

        <!-- Analytics/Toolbar Section (Right) -->
        <div class="w-full lg:w-96 flex-shrink-0 flex flex-col gap-4 overflow-y-auto">
            <!-- Chart Section -->
            <div class="w-full bg-secondary-bg rounded-xl p-4 shadow-sm border border-primary-border">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-text-color font-semibold text-lg">Analytics</h3>
                </div>
                <div class="w-full h-48">
                    <canvas id="analyticsChart"></canvas>
                </div>
            </div>

            <!-- Statistics Summary -->
            <div class="w-full bg-secondary-bg rounded-xl p-4 shadow-sm border border-primary-border">
                <h3 class="text-text-color font-semibold text-lg mb-3">Statistics</h3>
                <div id="statsContainer" class="space-y-3">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Export Options -->
            <div class="w-full bg-secondary-bg rounded-xl p-4 shadow-sm border border-primary-border">
                <h3 class="text-text-color font-semibold text-lg mb-3">Export Data</h3>
                <div class="flex gap-2">
                    <a href="{{ url_for('export_csv', task_id=taskID) }}"
                        class="btn-primary flex-1 flex items-center justify-center gap-2 hover:bg-hover-btn py-2 text-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" x2="12" y1="15" y2="3" />
                        </svg>
                        CSV
                    </a>
                    <a href="{{ url_for('export_json', task_id=taskID) }}"
                        class="btn-primary flex-1 flex items-center justify-center gap-2 hover:bg-hover-btn py-2 text-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                        </svg>
                        JSON
                    </a>
                </div>
            </div>

            <!-- Video Details -->
            <div
                class="w-full bg-secondary-bg rounded-xl p-4 shadow-sm border border-primary-border flex flex-col gap-2 text-sm text-secondary-text">
                <h3 class="text-text-color font-semibold text-lg mb-2">Details</h3>
                <p class="flex justify-between">
                    <span>Resolution:</span>
                    <span class="value text-text-color">{{ width }} Ã— {{ height }} px</span>
                </p>
                <p class="flex justify-between">
                    <span>Process Time:</span>
                    <span class="value text-text-color">{{ process_time }} s</span>
                </p>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script id="detection-data" type="application/json">
    {{ detection_data | tojson }}
</script>
<script id="zones-data" type="application/json">
    {{ zones | tojson }}
</script>
<script>
    const detectionData = JSON.parse(document.getElementById('detection-data').textContent);
    const zonesData = JSON.parse(document.getElementById('zones-data').textContent) || [];
    const processTime = {{ process_time or 0 }};

    // HSL to RGB helper (matches zone.js)
    function hslToRgb(h, s, l) {
        s /= 100;
        l /= 100;
        const k = n => (n + h / 30) % 12;
        const a = s * Math.min(l, 1 - l);
        const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
        return [Math.round(255 * f(0)), Math.round(255 * f(8)), Math.round(255 * f(4))];
    }

    function getColorFromClassId(classId) {
        const hue = (classId * 137.508) % 360;
        return hslToRgb(hue, 85, 55);
    }

    function getZoneColor(zoneId, idx) {
        const zone = zonesData.find(z => z.id === zoneId);
        if (zone && zone.color) {
            return `rgb(${zone.color[0]}, ${zone.color[1]}, ${zone.color[2]})`;
        } else if (zone && zone.classId) {
            const [r, g, b] = getColorFromClassId(zone.classId);
            return `rgb(${r}, ${g}, ${b})`;
        }
        const fallbackColors = ['#1F6F65', '#F59E0B', '#EF4444', '#8B5CF6', '#10B981'];
        return fallbackColors[idx % fallbackColors.length];
    }

    // Calculate statistics for each zone
    function calculateStats(zoneEvents, labels, zoneId) {
        let maxCount = 0;
        let maxTime = 0;
        let total = 0;
        let lastCount = 0;

        labels.forEach(time => {
            const count = zoneEvents[zoneId]?.[time];
            if (count !== undefined) {
                lastCount = count;
            }
            if (lastCount > maxCount) {
                maxCount = lastCount;
                maxTime = time;
            }
        });

        total = lastCount;
        const avgPerMinute = processTime > 0 ? (total / (processTime / 60)).toFixed(1) : 0;

        return { total, peak: maxCount, peakTime: maxTime, avgPerMinute };
    }

    // Render statistics UI
    function renderStats(statsMap, zoneColors) {
        const container = document.getElementById('statsContainer');
        if (!container) return;

        let html = '';
        Object.entries(statsMap).forEach(([zoneId, stats], idx) => {
            const zone = zonesData.find(z => z.id === zoneId);
            const zoneName = zone?.label || `Zone ${idx + 1}`;
            const color = zoneColors[zoneId];

            html += `
                <div class="p-3 bg-primary-color rounded-lg border border-primary-border">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${color}"></div>
                        <span class="text-sm font-medium text-text-color">${zoneName}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                        <div>
                            <div class="text-lg font-bold text-dropzone-accent">${stats.total}</div>
                            <div class="text-muted-foreground">Total</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-text-color">${stats.peak}</div>
                            <div class="text-muted-foreground">Peak @ ${stats.peakTime}s</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-text-color">${stats.avgPerMinute}</div>
                            <div class="text-muted-foreground">/min</div>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html || '<p class="text-sm text-muted-foreground italic">No data available</p>';
    }

    if (detectionData && detectionData.length > 0) {
        const ctx = document.getElementById('analyticsChart').getContext('2d');

        // Group detection events by zone
        const zoneEvents = {};
        const allTimes = new Set();

        detectionData.forEach(d => {
            const zoneId = d.zone_id || 'default';
            if (!zoneEvents[zoneId]) {
                zoneEvents[zoneId] = {};
            }
            zoneEvents[zoneId][d.time] = d.count;
            allTimes.add(d.time);
        });

        const labels = Array.from(allTimes).sort((a, b) => a - b);
        const zoneIds = Object.keys(zoneEvents);

        // Build datasets and collect stats
        const datasets = [];
        const statsMap = {};
        const zoneColors = {};
        const peakAnnotations = {};

        zoneIds.forEach((zoneId, idx) => {
            const color = getZoneColor(zoneId, idx);
            zoneColors[zoneId] = color;

            // Calculate stats
            const stats = calculateStats(zoneEvents, labels, zoneId);
            statsMap[zoneId] = stats;

            // Build data array
            let lastCount = 0;
            const data = labels.map(time => {
                if (zoneEvents[zoneId][time] !== undefined) {
                    lastCount = zoneEvents[zoneId][time];
                }
                return lastCount;
            });

            datasets.push({
                label: zonesData.find(z => z.id === zoneId)?.label || `Zone ${idx + 1}`,
                data: data,
                borderColor: color,
                backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 4,
                fill: true,
                tension: 0.4
            });

            // Peak annotation
            const peakIndex = labels.indexOf(stats.peakTime);
            if (peakIndex >= 0) {
                peakAnnotations[`peak_${zoneId}`] = {
                    type: 'point',
                    xValue: stats.peakTime,
                    yValue: stats.peak,
                    backgroundColor: color,
                    borderColor: '#fff',
                    borderWidth: 2,
                    radius: 6
                };
            }
        });

        // Render stats
        renderStats(statsMap, zoneColors);

        // Create chart with annotations
        new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        display: datasets.length > 1,
                        position: 'top',
                        labels: { color: '#9ca3af', usePointStyle: true, pointStyle: 'circle' }
                    },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        titleColor: '#f3f4f6',
                        bodyColor: '#d1d5db',
                        padding: 10
                    },
                    annotation: {
                        annotations: peakAnnotations
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: '#9ca3af', maxTicksLimit: 8 },
                        title: { display: true, text: 'Time (s)', color: '#6b7280' }
                    },
                    y: {
                        grid: { color: 'rgba(55, 65, 81, 0.5)' },
                        ticks: { color: '#9ca3af', precision: 0 },
                        beginAtZero: true
                    }
                }
            }
        });
    } else {
        // No data
        document.getElementById('statsContainer').innerHTML =
            '<p class="text-sm text-muted-foreground italic">No detection data available</p>';
    }
</script>
<script src="{{url_for('static', filename='js/result.js')}}"></script>
{% endblock %}
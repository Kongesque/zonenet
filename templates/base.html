<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZoneNet</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}">
    <script>
        // Check for saved theme preference or system preference
        if (localStorage.theme === 'light' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: light)').matches)) {
            document.documentElement.classList.add('light')
        } else {
            document.documentElement.classList.remove('light')
        }
    </script>
    {% block head %}{% endblock %}
</head>

<body class="bg-background text-sidebar-foreground h-screen overflow-hidden flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">

        <p></p>
        <span></span>
    </div>



    <!-- Header -->
    <header id="content-header" class="flex justify-between items-center py-2.5 px-3 bg-transparent">
        <a href="{{ url_for('main') }}" class="no-underline">
            <div class="text-lg font-semibold text-text-color tracking-tight font-mono">ZoneNet</div>
        </a>
        <div class="flex items-center gap-2">
            <!-- GPU/CPU Status Badge -->
            <div id="device-badge" class="hidden px-2 py-0.5 text-xs font-medium rounded-full cursor-default"
                title="Compute Device">
                <span id="device-text">CPU</span>
            </div>
            <button onclick="toggleTheme()"
                class="w-8 h-8 flex items-center justify-center rounded-md hover:bg-btn-hover transition-colors text-text-color cursor-pointer"
                title="Toggle Theme">
                <!-- Sun Icon (for Dark Mode) -->
                <!-- Sun Icon (for Dark Mode) -->
                <div class="block light:hidden w-5 h-5 bg-text-color mask-icon"
                    style="--mask-url: url('{{ url_for('static', filename='img/icons/sun.svg') }}');">
                </div>
                <!-- Moon Icon (for Light Mode) -->
                <div class="hidden light:block w-5 h-5 bg-text-color mask-icon"
                    style="--mask-url: url('{{ url_for('static', filename='img/icons/moon.svg') }}');">
                </div>
            </button>
            {% block header_actions %}
            {% endblock %}
        </div>
    </header>

    <!-- Main Layout Container -->
    <div id="app-container" class="flex flex-1 overflow-hidden">

        {% block sidebar %}{% endblock %}

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col min-w-0 overflow-auto">
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- Global Sidebar Menu -->
    <div id="global-menu"
        class="hidden fixed z-[9999] w-32 bg-btn-bg border border-btn-border rounded shadow-lg flex-col py-1">
        <button id="menu-rename-btn"
            class="w-full text-left px-3 py-1.5 text-xs text-text-color hover:bg-btn-hover">Rename</button>
        <button id="menu-delete-btn"
            class="w-full text-left px-3 py-1.5 text-xs text-delete-text hover:bg-delete-text/10">Delete</button>
    </div>

    <!-- Scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="{{url_for('static', filename='js/sidebar.js')}}"></script>
    <script>
        $(document).ready(function () {
            $('#loading').hide();

            // Fetch GPU status and update badge
            fetch('/api/system-info')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('device-badge');
                    const text = document.getElementById('device-text');
                    if (badge && text && data.gpu) {
                        const isGpu = data.gpu.available;
                        text.textContent = isGpu ? 'GPU' : 'CPU';
                        badge.title = data.gpu.name || 'Compute Device';
                        badge.classList.remove('hidden');
                        if (isGpu) {
                            badge.classList.add('bg-green-500/20', 'text-green-400');
                        } else {
                            badge.classList.add('bg-gray-500/20', 'text-gray-400');
                        }
                    }
                })
                .catch(() => {/* Silently fail - badge stays hidden */ });
        });

        function loading() {
            $("header#content-header").hide();
            $("main#content").hide();
            $("footer#content").hide();
            $("#loading").show();

            $("#loading p").text("Uploading files...");
            $("#loading span").html("The process may take a moment, please<br>keep this window open.");
        };

        // Sidebar Menu Logic (Global)
        let activeMenuId = null;

        function toggleMenu(event, id) {
            event.preventDefault();
            event.stopPropagation();

            const menu = document.getElementById('global-menu');
            const btn = event.currentTarget;
            const rect = btn.getBoundingClientRect();

            // If clicking the same button to close
            if (activeMenuId === id && !menu.classList.contains('hidden')) {
                closeMenu();
                return;
            }

            // If another menu was open, close it first
            if (activeMenuId && activeMenuId !== id) {
                closeMenu();
            }

            // Position: Right of button, aligned top, with more gap (12px)
            menu.style.top = `${rect.top}px`;
            menu.style.left = `${rect.right + 8}px`;

            // Wire up buttons
            document.getElementById('menu-rename-btn').onclick = () => startRename(id);
            document.getElementById('menu-delete-btn').onclick = () => deleteJob(id);

            // Show menu
            menu.classList.remove('hidden');
            menu.classList.add('flex');

            // Set active state on button AND parent row
            btn.classList.add('bg-sidebar-menu-hover', 'opacity-100');
            const row = btn.closest('.group');
            if (row) row.classList.add('bg-sidebar-item-hover');

            activeMenuId = id;
        }

        function closeMenu() {
            const menu = document.getElementById('global-menu');
            menu.classList.add('hidden');
            menu.classList.remove('flex');

            if (activeMenuId) {
                const btn = document.getElementById(`menu-btn-${activeMenuId}`);
                if (btn) {
                    btn.classList.remove('bg-sidebar-menu-hover', 'opacity-100');
                    // Remove active state from parent row
                    const row = btn.closest('.group');
                    if (row) row.classList.remove('bg-sidebar-item-hover');
                }
                activeMenuId = null;
            }
        }

        // Close menus on clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('global-menu');
            // If click is not inside the menu and menu is visible
            if (menu && !menu.contains(e.target) && !menu.classList.contains('hidden')) {
                // Also check if click is on the current active button (handled by toggleMenu)
                if (activeMenuId) {
                    const btn = document.getElementById(`menu-btn-${activeMenuId}`);
                    // If clicking the button itself, let toggleMenu handle it to avoid double-toggle
                    if (btn && btn.contains(e.target)) return;
                }
                closeMenu();
            }
        });

        function startRename(id, currentName) {
            const titleEl = document.getElementById(`title-${id}`);
            if (!titleEl) return;

            // Close the global menu
            closeMenu();

            // Create Input
            const input = document.createElement('input');
            input.type = 'text';
            // Use current text content if name is missing/default
            input.value = (currentName && currentName !== 'None' && currentName !== 'Untitled') ? currentName : titleEl.innerText.trim();

            // Styled to blend in: transparent bg, bottom border only
            input.className = "flex-1 block px-2 py-1 text-sm text-sidebar-foreground border-b border-gray-600 outline-none w-full placeholder-gray-500 focus:border-blue-500 transition-colors appearance-none bg-transparent";

            // Force styles with !important to override any user agent or tailwind weirdness
            input.style.setProperty('background', 'transparent', 'important');
            input.style.setProperty('background-color', 'transparent', 'important');
            input.style.setProperty('background-image', 'none', 'important');
            input.style.setProperty('box-shadow', 'none', 'important');
            input.style.color = "inherit";

            // Hide title, show input
            titleEl.classList.add('hidden');
            titleEl.parentNode.insertBefore(input, titleEl);
            input.focus();

            // Event Handlers
            input.addEventListener('blur', () => saveRename(id, input.value, titleEl, input));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    cancelRename(titleEl, input);
                }
            });
        }

        function saveRename(id, newName, titleEl, input) {
            // Prevent multiple calls (blur + enter)
            if (!document.body.contains(input)) return;

            const finalName = newName.trim();
            if (finalName && finalName !== titleEl.innerText.trim()) {
                fetch(`/api/history/${id}/rename`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: finalName })
                }).then(response => {
                    if (response.ok) {
                        // Update UI without reload
                        titleEl.textContent = finalName;
                        cancelRename(titleEl, input);
                        // No need to update onclicks since toggleMenu does it dynamically
                    } else {
                        cancelRename(titleEl, input);
                        // Optional: show error
                    }
                }).catch(() => {
                    cancelRename(titleEl, input);
                });
            } else {
                cancelRename(titleEl, input);
            }
        }

        function cancelRename(titleEl, input) {
            if (input.parentNode) input.remove();
            titleEl.classList.remove('hidden');
        }

        function deleteJob(id) {
            // Immediate delete, no confirmation
            fetch(`/api/history/${id}`, {
                method: 'DELETE'
            }).then(() => {
                closeMenu(); // Close the dropdown menu
                // If we are on the page of the deleted job, go to main
                if (window.location.href.includes(id)) {
                    window.location.href = "{{ url_for('main') }}";
                } else {
                    // Update UI without reload: Remove the item row
                    const titleEl = document.getElementById(`title-${id}`);
                    if (titleEl) {
                        const group = titleEl.closest('.group');
                        if (group) group.remove();

                        // Check if list is empty and show "No history" msg if needed
                        const container = document.querySelector('nav');
                        // We check if there are any other .group elements
                        if (!container.querySelector('.group')) {
                            // Append the "no history" div if not present
                            if (!container.innerText.includes("No history yet")) {
                                container.insertAdjacentHTML('beforeend', '<div class="px-2 py-2 text-xs text-muted-foreground italic">No history yet</div>');
                            }
                        }
                    }
                }
            });
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('light')) {
                document.documentElement.classList.remove('light');
                localStorage.theme = 'dark';
            } else {
                document.documentElement.classList.add('light');
                localStorage.theme = 'light';
            }
        }
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>
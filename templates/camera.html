{% extends 'base.html' %}

{% block sidebar %}
<!-- Mobile Backdrop -->
<div id="backdrop" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40 hidden lg:hidden" onclick="toggleSidebar()">
</div>

<!-- Sidebar -->
<aside id="sidebar"
    class="fixed lg:relative z-50 h-full bg-background flex flex-col overflow-hidden -translate-x-full lg:translate-x-0 w-60 lg:w-60"
    data-expanded="true">

    <!-- Sidebar Content -->
    <nav class="flex-1 p-2 space-y-1 overflow-y-auto overflow-x-hidden w-60">
        <!-- Section Header -->
        <div class="px-2 py-2">
            <span class="text-sm font-medium text-sidebar-foreground whitespace-nowrap">History</span>
        </div>

        <!-- Navigation Items -->
        {% if history_jobs %}
        {% for job in history_jobs %}
        <div class="group relative flex items-center rounded-md hover:bg-sidebar-item-hover pr-2
            {% if current_taskID == job.id %}bg-sidebar-accent text-sidebar-foreground{% endif %}">
            <a href="{{ url_for('result', taskID=job.id) }}" id="title-{{ job.id }}"
                class="flex-1 block px-2 py-2 text-sm whitespace-nowrap overflow-hidden text-ellipsis
                    {% if current_taskID == job.id %}font-medium{% else %}text-muted-foreground hover:text-sidebar-foreground{% endif %}">
                {{ job.name or job.filename or 'Untitled' }}
            </a>

            <!-- 3-dot Menu Trigger -->
            <button id="menu-btn-{{ job.id }}" onclick="toggleMenu(event, '{{ job.id }}')"
                class="opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-sidebar-menu-hover text-muted-foreground transition-opacity">
                <div class="w-4 h-4 opacity-80 bg-text-color mask-icon"
                    style="--mask-url: url('{{ url_for('static', filename='img/menu_dots.svg') }}');">
                </div>
            </button>
        </div>
        {% endfor %}
        {% else %}
        <div class="px-2 py-2 text-xs text-secondary-text italic">No history yet</div>
        {% endif %}
    </nav>
</aside>
{% endblock %}

{% block content %}
<!-- Main Content -->
<main id="content"
    class="relative flex-1 flex items-center justify-center flex-col text-center mx-2 mt-0 mb-2 overflow-hidden bg-primary-color border border-primary-border rounded-md">

    <button onclick="toggleSidebar()"
        class="absolute top-4 left-4 p-1.5 rounded-md hover:bg-sidebar-accent transition-colors cursor-pointer">
        <img src="{{ url_for('static', filename='img/sidebar.svg') }}"
            class="w-5 h-5 invert dark-only-invert opacity-80">
    </button>

    <!-- Back Button -->
    <a href="{{ url_for('main') }}"
        class="absolute top-4 right-4 flex items-center gap-2 px-3 py-1.5 text-sm text-muted-foreground hover:text-text-color rounded-md hover:bg-sidebar-accent transition-colors">
        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back
    </a>

    <div class="mb-6">
        <h1 class="text-3xl md:text-5xl font-bold text-sidebar-foreground tracking-tight leading-tight">
            Connect Live Camera
        </h1>
        <p class="text-muted-foreground mt-2">Enter RTSP URL or use your webcam</p>
    </div>

    <div class="w-full max-w-xl px-4">
        <!-- Error Message -->
        {% if error %}
        <div class="mb-4 p-3 bg-delete-text/10 border border-delete-text rounded-lg text-delete-text text-sm">
            {{ error }}
        </div>
        {% endif %}

        <!-- RTSP Form -->
        <form method="POST" class="space-y-6" id="cameraForm">
            <!-- RTSP URL Input -->
            <div class="space-y-2">
                <label class="block text-left text-sm font-medium text-text-color">RTSP URL</label>
                <input type="text" name="stream_url" id="streamUrl"
                    placeholder="rtsp://username:password@192.168.1.100:554/stream"
                    class="w-full px-4 py-3 bg-dropzone-hover-bg border border-primary-border rounded-lg text-text-color placeholder-secondary-text focus:outline-none focus:border-dropzone-accent transition-colors">
                <p class="text-xs text-secondary-text text-left">
                    Examples: rtsp://camera:554/live or rtsp://user:pass@ip:port/stream
                </p>
            </div>

            <input type="hidden" name="source_type" id="sourceType" value="rtsp">

            <!-- Submit Button -->
            <button type="submit" id="connectBtn"
                class="w-full px-6 py-3 bg-dropzone-accent text-white font-medium rounded-lg hover:opacity-90 transition-opacity cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                Connect to Stream
            </button>
        </form>

        <!-- Divider -->
        <div class="flex items-center gap-4 my-6">
            <div class="flex-1 h-px bg-primary-border"></div>
            <span class="text-secondary-text text-sm">or</span>
            <div class="flex-1 h-px bg-primary-border"></div>
        </div>

        <!-- Webcam Button -->
        <button type="button" id="webcamBtn" onclick="useWebcam()"
            class="w-full flex items-center justify-center gap-3 px-6 py-3 border-2 border-dashed border-primary-border rounded-lg text-text-color hover:border-dropzone-accent hover:bg-dropzone-hover-bg transition-all cursor-pointer">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            <span class="font-medium">Use Webcam</span>
        </button>

        <!-- Test Connection Button -->
        <button type="button" id="testBtn" onclick="testConnection()"
            class="mt-4 w-full px-4 py-2 text-sm text-secondary-text border border-primary-border rounded-lg hover:text-text-color hover:border-dropzone-accent transition-colors cursor-pointer">
            Test Connection
        </button>
        <p id="testResult" class="mt-2 text-sm hidden"></p>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    function useWebcam() {
        document.getElementById('streamUrl').value = '0';
        document.getElementById('sourceType').value = 'webcam';
        document.getElementById('cameraForm').submit();
    }

    function testConnection() {
        const url = document.getElementById('streamUrl').value.trim();
        const testResult = document.getElementById('testResult');
        const testBtn = document.getElementById('testBtn');

        if (!url) {
            testResult.textContent = 'Please enter an RTSP URL first';
            testResult.className = 'mt-2 text-sm text-delete-text';
            testResult.classList.remove('hidden');
            return;
        }

        testBtn.disabled = true;
        testBtn.textContent = 'Testing...';
        testResult.textContent = 'Connecting to stream...';
        testResult.className = 'mt-2 text-sm text-muted-foreground';
        testResult.classList.remove('hidden');

        fetch('/api/camera/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stream_url: url })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    testResult.textContent = `✓ Connected! Resolution: ${data.width}x${data.height}`;
                    testResult.className = 'mt-2 text-sm text-green-500';
                } else {
                    testResult.textContent = `✗ Failed: ${data.error}`;
                    testResult.className = 'mt-2 text-sm text-delete-text';
                }
            })
            .catch(err => {
                testResult.textContent = `✗ Error: ${err.message}`;
                testResult.className = 'mt-2 text-sm text-delete-text';
            })
            .finally(() => {
                testBtn.disabled = false;
                testBtn.textContent = 'Test Connection';
            });
    }

    // Form validation
    document.getElementById('cameraForm').addEventListener('submit', function (e) {
        const url = document.getElementById('streamUrl').value.trim();
        const sourceType = document.getElementById('sourceType').value;

        if (!url && sourceType !== 'webcam') {
            e.preventDefault();
            const testResult = document.getElementById('testResult');
            testResult.textContent = 'Please enter an RTSP URL';
            testResult.className = 'mt-2 text-sm text-delete-text';
            testResult.classList.remove('hidden');
        }
    });
</script>
{% endblock %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZoneNet</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}">
    <script>
        // Check for saved theme preference or system preference
        if (localStorage.theme === 'light' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: light)').matches)) {
            document.documentElement.classList.add('light')
        } else {
            document.documentElement.classList.remove('light')
        }
    </script>
</head>

<body class="bg-background text-text-color font-sans h-screen overflow-hidden flex flex-col">



    <header id="content" class="flex justify-between items-center py-2.5 px-3 bg-transparent">
        <a href="{{ url_for('main') }}" class="no-underline">
            <div class="text-lg font-semibold text-text-color tracking-tight font-mono">ZoneNet</div>
        </a>
        <div class="flex items-center gap-2">
            <button onclick="toggleTheme()"
                class="w-8 h-8 flex items-center justify-center rounded-md hover:bg-btn-hover transition-colors text-text-color cursor-pointer"
                title="Toggle Theme">
                <!-- Sun Icon (for Dark Mode) -->
                <svg class="block light:hidden w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5" />
                    <line x1="12" y1="1" x2="12" y2="3" />
                    <line x1="12" y1="21" x2="12" y2="23" />
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                    <line x1="1" y1="12" x2="3" y2="12" />
                    <line x1="21" y1="12" x2="23" y2="12" />
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                </svg>
                <!-- Moon Icon (for Light Mode) -->
                <svg class="hidden light:block w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                </svg>
            </button>
        </div>
    </header>

    <main id="content" class="flex-1 flex items-center justify-center p-3 overflow-hidden">
        <div class="flex flex-col md:flex-row w-full h-full gap-4 md:gap-6">

            <!-- Tools Sidebar -->
            <section
                class="w-full md:w-[280px] shrink-0 p-4 md:p-6 flex flex-col gap-4 md:justify-between order-2 md:order-1 bg-primary-color border border-primary-border rounded-xl">
                <div>
                    <h2 class="text-sm font-semibold text-text-color mb-4">Area Selection</h2>

                    <div class="space-y-4">
                        <!-- Object Class Selector -->
                        <div class="object-class">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-secondary-text">Target Object</span>
                            </div>
                            <select id="classSelector"
                                class="w-full bg-btn-bg text-text-color border border-btn-border rounded-lg p-2 text-sm focus:outline-none focus:border-blue-500 appearance-none cursor-pointer">
                                {% for id, name in coco_classes|dictsort(false, 'value') %}
                                <option value="{{ id }}" {% if id==19 %}selected{% endif %}>{{ name|capitalize }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Confidence Slider -->
                        <div class="slider-confidence">
                            <div class="confidence-info flex justify-between text-sm mb-2">
                                <span class="text-secondary-text">Confidence Threshold</span>
                                <span class="value-confidence text-text-color font-medium">40%</span>
                            </div>
                            <input type="range" id="confidenceSlider" value="40" min="1" max="100"
                                class="w-full h-1 bg-gray-500 rounded-full appearance-none cursor-pointer accent-text-color">
                        </div>

                        <!-- Points Slider -->
                        <div class="slider">
                            <div class="point-info flex justify-between text-sm mb-2">
                                <span class="text-secondary-text">Points</span>
                                <span class="value text-text-color font-medium">4</span>
                            </div>
                            <input type="range" value="4" min="3" max="8"
                                class="w-full h-1 bg-gray-500 rounded-full appearance-none cursor-pointer accent-text-color">
                        </div>



                        <!-- Clear Button -->
                        <button
                            class="draw w-full py-2.5 md:py-2 text-sm text-secondary-text border border-dashed border-btn-border rounded-lg hover:border-text-color hover:text-text-color transition-all cursor-pointer">Clear</button>
                    </div>
                </div>

                <form action="{{ url_for('submit') }}" method="post" class="mt-4 md:mt-0">
                    <input type="hidden" name="target_class" id="targetClassInput" value="19">
                    <input type="hidden" name="confidence" id="confidenceInput" value="40">
                    <div class="run disable">
                        <button class="process btn-primary w-full py-3" onclick="loading();">Process</button>
                    </div>
                </form>
            </section>

            <!-- Canvas Area -->
            <section
                class="flex-1 flex items-center justify-center p-2 md:p-4 order-1 md:order-2 min-h-0 overflow-hidden bg-primary-color border border-primary-border rounded-xl">
                <img id="image" src="{{ url_for('media_file', filename='frames/' + 'frame_' + taskID + '.jpg') }}"
                    hidden>
                <canvas class="display max-w-full max-h-full rounded-lg" id="canvas"></canvas>
            </section>
        </div>
    </main>

    <footer id="content"
        class="flex flex-col md:flex-row justify-between items-center gap-2 py-2.5 px-3 border-t border-primary-border bg-transparent">
        <div class="flex gap-4 md:gap-6 text-sm text-secondary-text">
            <p class="size-width">
                <span>Width: </span>
                <span class="value text-text-color"> - px</span>
            </p>
            <p class="size-height">
                <span>Height: </span>
                <span class="value text-text-color"> - px</span>
            </p>
        </div>
    </footer>


    <!-- Loading Screen -->
    <div id="loading" class="loading-overlay hidden">
        <div class="flex flex-col items-center justify-center">

            <!-- Circular Progress -->
            <div class="relative w-24 h-24">
                <svg class="w-full h-full -rotate-90" viewBox="0 0 100 100">
                    <!-- Background circle -->
                    <circle class="stroke-gray-400/20" cx="50" cy="50" r="42" fill="none" stroke-width="6"></circle>
                    <!-- Progress circle (circumference = 2 * π * 42 ≈ 264) -->
                    <circle id="progressCircle" class="stroke-text-color transition-all duration-300" cx="50" cy="50"
                        r="42" fill="none" stroke-width="6" stroke-linecap="round" stroke-dasharray="264"
                        stroke-dashoffset="264"></circle>
                </svg>
                <!-- Percentage text in center -->
                <div class="absolute inset-0 flex items-center justify-center">
                    <span id="progressText"
                        class="text-xl font-medium text-text-color tabular-nums -translate-y-px">0</span>
                </div>
            </div>

            <!-- Text Content -->
            <div class="flex flex-col items-center">
                <p class="text-lg font-medium text-text-color">
                    Processing video<span class="animate-pulse">...</span>
                </p>
                <span class="text-base text-secondary-text">Analyzing frames and detecting objects</span>
            </div>

        </div>
    </div>

    <div id="responseMessage"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="{{url_for('static', filename='js/zone.js')}}"></script>
    <script>
        $(document).ready(function () {
            $('#loading').hide();
        });

        function loading() {
            $("header#content").hide();
            $("main#content").hide();
            $("footer#content").hide();
            $("#loading").removeClass("hidden").css("display", "flex");

            const circle = document.getElementById('progressCircle');
            const text = document.getElementById('progressText');
            const circumference = 264; // 2 * π * 42
            const taskID = "{{ taskID }}";

            // Poll backend for real progress
            const pollProgress = () => {
                fetch(`/api/progress/${taskID}`)
                    .then(response => response.json())
                    .then(data => {
                        const progress = data.progress || 0;

                        // Update circle (offset goes from 264 to 0)
                        const offset = circumference - (progress / 100) * circumference;
                        circle.style.strokeDashoffset = offset;
                        text.innerText = progress;

                        // If completed, the form will redirect automatically
                        // Keep polling until redirected
                        if (data.status !== 'completed') {
                            setTimeout(pollProgress, 500);
                        }
                    })
                    .catch(() => {
                        // On error, retry after delay
                        setTimeout(pollProgress, 1000);
                    });
            };

            // Start polling after a short delay to let the form submit
            setTimeout(pollProgress, 1000);
        };

        // Handle Class Selection
        const classSelector = document.getElementById('classSelector');
        const targetClassInput = document.getElementById('targetClassInput');

        if (classSelector && targetClassInput) {
            classSelector.addEventListener('change', (e) => {
                targetClassInput.value = e.target.value;
            });
        }

        // Handle Confidence Slider
        const confidenceSlider = document.getElementById('confidenceSlider');
        const confidenceInput = document.getElementById('confidenceInput');
        const confidenceValue = document.querySelector('.value-confidence');

        if (confidenceSlider && confidenceInput && confidenceValue) {
            confidenceSlider.addEventListener('input', (e) => {
                confidenceValue.innerText = `${e.target.value}%`;
                confidenceInput.value = e.target.value;
            });
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('light')) {
                document.documentElement.classList.remove('light');
                localStorage.theme = 'dark';
            } else {
                document.documentElement.classList.add('light');
                localStorage.theme = 'light';
            }
        }
    </script>

</body>

</html>
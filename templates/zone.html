<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZoneNet</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}">
    <script>
        // Check for saved theme preference or system preference
        if (localStorage.theme === 'light' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: light)').matches)) {
            document.documentElement.classList.add('light')
        } else {
            document.documentElement.classList.remove('light')
        }
    </script>
</head>

<body class="bg-background text-text-color font-sans h-screen overflow-hidden flex flex-col">



    <header id="content" class="flex justify-between items-center py-2.5 px-3 bg-transparent">
        <a href="{{ url_for('main') }}" class="no-underline">
            <div class="text-lg font-semibold text-text-color tracking-tight font-mono">ZoneNet</div>
        </a>
        <div class="flex items-center gap-2">
            <button onclick="toggleTheme()"
                class="w-8 h-8 flex items-center justify-center rounded-md hover:bg-btn-hover transition-colors text-text-color cursor-pointer"
                title="Toggle Theme">
                <!-- Sun Icon (for Dark Mode) -->
                <!-- Sun Icon (for Dark Mode) -->
                <div class="block light:hidden w-5 h-5 bg-text-color mask-icon"
                    style="--mask-url: url('{{ url_for('static', filename='img/icons/sun.svg') }}');">
                </div>
                <!-- Moon Icon (for Light Mode) -->
                <div class="hidden light:block w-5 h-5 bg-text-color mask-icon"
                    style="--mask-url: url('{{ url_for('static', filename='img/icons/moon.svg') }}');">
                </div>
            </button>
        </div>
    </header>

    <main id="content" class="flex-1 flex items-center justify-center p-3 overflow-hidden">
        <div class="flex flex-col md:flex-row w-full h-full gap-4 md:gap-6">

            <!-- Tools Sidebar -->
            <section
                class="w-full md:w-[280px] shrink-0 p-2 md:p-4 flex flex-col gap-4 md:justify-between order-2 md:order-1 bg-primary-color border border-primary-border rounded-xl">
                <div class="overflow-y-auto max-h-[calc(100vh-200px)] p-3">
                    <h2 class="text-sm font-semibold text-text-color mb-4">Zone Selection</h2>

                    <!-- Zone List -->
                    <div id="zoneList" class="space-y-4 mb-4">
                        <!-- Zones will be dynamically added here -->
                    </div>

                    <!-- Add Zone Button -->
                    <button id="addZoneBtn"
                        class="w-full py-2 text-sm text-secondary-text border border-dashed border-btn-border rounded-lg hover:border-text-color hover:text-text-color transition-all cursor-pointer flex items-center justify-center gap-2 mb-4">
                        <div class="w-4 h-4 bg-current mask-icon"
                            style="--mask-url: url('{{ url_for('static', filename='img/icons/plus.svg') }}');">
                        </div>
                        Add Zone
                    </button>

                    <div class="space-y-4">
                        <!-- Points Slider -->
                        <div class="slider">
                            <div class="point-info flex justify-between text-sm mb-2">
                                <span class="text-secondary-text">Points</span>
                                <span class="value text-text-color font-medium">4</span>
                            </div>
                            <input type="range" value="4" min="2" max="8"
                                class="w-full h-1 bg-gray-500 rounded-full appearance-none cursor-pointer accent-text-color">
                        </div>

                        <!-- Confidence Slider -->
                        <div class="slider-confidence">
                            <div class="confidence-info flex justify-between text-sm mb-2">
                                <span class="text-secondary-text">Confidence Threshold</span>
                                <span class="value-confidence text-text-color font-medium">35%</span>
                            </div>
                            <input type="range" id="confidenceSlider" value="35" min="1" max="100"
                                class="w-full h-1 bg-gray-500 rounded-full appearance-none cursor-pointer accent-text-color">
                        </div>
                    </div>

                    <!-- Model Selection -->
                    <div class="model-selection mt-4">
                        <div class="model-info flex justify-between text-sm mb-2">
                            <span class="text-secondary-text">Model</span>
                            <span class="text-text-color font-medium" id="selectedModelText">Fastest</span>
                        </div>
                        <select id="modelSelect"
                            class="w-full bg-secondary-bg text-text-color border border-btn-border rounded-lg p-1.5 text-xs focus:outline-none focus:border-blue-500 appearance-none cursor-pointer">
                            <option value="yolo11n.pt" selected>YOLO11n (Fastest)</option>
                            <option value="yolo11s.pt">YOLO11s (Fast)</option>
                            <option value="yolo11m.pt">YOLO11m (Balanced)</option>
                            <option value="yolo11l.pt">YOLO11l (Accurate)</option>
                            <option value="yolo11x.pt">YOLO11x (Most Accurate)</option>
                        </select>
                    </div>

                    <!-- Advanced Settings (Collapsible) -->
                    <div class="advanced-settings mt-4">
                        <button type="button" id="advancedToggle"
                            class="w-full flex items-center justify-between text-xs text-secondary-text hover:text-text-color transition-colors cursor-pointer py-2">
                            <span class="flex items-center gap-2">
                                <div class="w-3.5 h-3.5 bg-current mask-icon"
                                    style="--mask-url: url('{{ url_for('static', filename='img/icons/settings.svg') }}');">
                                </div>
                                Advanced Tracking Settings
                            </span>
                            <div id="advancedChevron"
                                class="w-4 h-4 bg-current mask-icon transition-transform duration-200"
                                style="--mask-url: url('{{ url_for('static', filename='img/icons/chevron.svg') }}');">
                            </div>
                        </button>

                        <div id="advancedPanel" class="hidden mt-3 space-y-4 pl-1 border-l-2 border-btn-border ml-1.5">
                            <!-- Detection Quality (track_high_thresh) -->
                            <div class="slider-advanced pl-3">
                                <div class="flex justify-between text-xs mb-1.5">
                                    <span class="text-secondary-text"
                                        title="Higher values = cleaner tracks, fewer false positives">Detection
                                        Quality</span>
                                    <span class="value-high-thresh text-text-color font-medium">0.45</span>
                                </div>
                                <input type="range" id="trackHighThresh" value="45" min="10" max="90" step="5"
                                    class="w-full h-1 bg-gray-500 rounded-full appearance-none cursor-pointer accent-text-color">
                            </div>

                            <!-- Recovery Sensitivity (track_low_thresh) -->
                            <div class="slider-advanced pl-3">
                                <div class="flex justify-between text-xs mb-1.5">
                                    <span class="text-secondary-text"
                                        title="Lower values = better recovery of occluded objects">Recovery
                                        Sensitivity</span>
                                    <span class="value-low-thresh text-text-color font-medium">0.10</span>
                                </div>
                                <input type="range" id="trackLowThresh" value="10" min="1" max="50" step="1"
                                    class="w-full h-1 bg-gray-500 rounded-full appearance-none cursor-pointer accent-text-color">
                            </div>

                            <!-- Match Threshold -->
                            <div class="slider-advanced pl-3">
                                <div class="flex justify-between text-xs mb-1.5">
                                    <span class="text-secondary-text"
                                        title="Lower values = more lenient matching, fewer ID switches">Match
                                        Threshold</span>
                                    <span class="value-match-thresh text-text-color font-medium">0.80</span>
                                </div>
                                <input type="range" id="matchThresh" value="80" min="30" max="95" step="5"
                                    class="w-full h-1 bg-gray-500 rounded-full appearance-none cursor-pointer accent-text-color">
                            </div>

                            <!-- Track Memory (track_buffer) -->
                            <div class="slider-advanced pl-3">
                                <div class="flex justify-between text-xs mb-1.5">
                                    <span class="text-secondary-text"
                                        title="Frames to remember lost tracks (higher = handles longer occlusions)">Track
                                        Memory</span>
                                    <span class="value-track-buffer text-text-color font-medium">30</span>
                                </div>
                                <input type="range" id="trackBuffer" value="30" min="10" max="120" step="5"
                                    class="w-full h-1 bg-gray-500 rounded-full appearance-none cursor-pointer accent-text-color">
                            </div>

                            <!-- Reset Button -->
                            <button type="button" id="resetAdvanced"
                                class="w-full text-xs text-secondary-text hover:text-text-color transition-colors py-1.5 cursor-pointer">
                                Reset to defaults
                            </button>
                        </div>
                    </div>
                </div>

                <form action="{{ url_for('submit') }}" method="post" class="mt-4 md:mt-0">
                    <input type="hidden" name="zones" id="zonesInput" value="[]">
                    <input type="hidden" name="confidence" id="confidenceInput" value="35">
                    <input type="hidden" name="model" id="modelInput" value="yolo11n.pt">
                    <input type="hidden" name="tracker_config" id="trackerConfigInput"
                        value='{"track_high_thresh":0.45,"track_low_thresh":0.1,"match_thresh":0.8,"track_buffer":30}'>
                    <div class="run disable">
                        <button class="process btn-primary w-full py-3" onclick="loading();">Process</button>
                    </div>
                </form>
            </section>

            <!-- Canvas Area -->
            <section
                class="flex-1 flex items-center justify-center p-2 md:p-4 order-1 md:order-2 min-h-0 overflow-hidden bg-primary-color border border-primary-border rounded-xl">
                <img id="image" src="{{ url_for('media_file', filename='frames/' + 'frame_' + taskID + '.jpg') }}"
                    hidden>
                <canvas class="display max-w-full max-h-full rounded-lg" id="canvas"></canvas>
            </section>
        </div>
    </main>

    <footer id="content"
        class="flex flex-col md:flex-row justify-between items-center gap-2 py-2.5 px-3 bg-transparent">
        <div class="flex gap-4 md:gap-6 text-sm text-secondary-text">
            <p class="size-width">
                <span>Width: </span>
                <span class="value text-text-color"> - px</span>
            </p>
            <p class="size-height">
                <span>Height: </span>
                <span class="value text-text-color"> - px</span>
            </p>
        </div>
    </footer>


    <!-- Loading Screen -->
    <div id="loading" class="loading-overlay hidden">
        <div class="flex flex-col items-center justify-center">

            <!-- Circular Progress -->
            <div class="relative w-24 h-24">
                <svg class="w-full h-full -rotate-90" viewBox="0 0 100 100">
                    <!-- Background circle -->
                    <circle class="stroke-gray-400/20" cx="50" cy="50" r="42" fill="none" stroke-width="6"></circle>
                    <!-- Progress circle (circumference = 2 * π * 42 ≈ 264) -->
                    <circle id="progressCircle" class="stroke-text-color transition-all duration-300" cx="50" cy="50"
                        r="42" fill="none" stroke-width="6" stroke-linecap="round" stroke-dasharray="264"
                        stroke-dashoffset="264"></circle>
                </svg>
                <!-- Percentage text in center -->
                <div class="absolute inset-0 flex items-center justify-center">
                    <span id="progressText"
                        class="text-xl font-medium text-text-color tabular-nums -translate-y-px">0</span>
                </div>
            </div>

            <!-- Text Content -->
            <div class="flex flex-col items-center">
                <p class="text-lg font-medium text-text-color">
                    Processing video<span class="animate-pulse">...</span>
                </p>
                <span class="text-base text-secondary-text">Analyzing frames and detecting objects</span>
            </div>

        </div>
    </div>

    <div id="responseMessage"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script id="coco-classes-data" type="application/json">{{ coco_classes | tojson }}</script>
    <script src="{{url_for('static', filename='js/zone.js')}}"></script>
    <script>
        $(document).ready(function () {
            $('#loading').hide();
        });

        function loading() {
            $("header#content").hide();
            $("main#content").hide();
            $("footer#content").hide();
            $("#loading").removeClass("hidden").css("display", "flex");

            const circle = document.getElementById('progressCircle');
            const text = document.getElementById('progressText');
            const circumference = 264; // 2 * π * 42
            const taskID = "{{ taskID }}";

            // Poll backend for real progress
            const pollProgress = () => {
                fetch(`/api/progress/${taskID}`)
                    .then(response => response.json())
                    .then(data => {
                        const progress = data.progress || 0;

                        // Update circle (offset goes from 264 to 0)
                        const offset = circumference - (progress / 100) * circumference;
                        circle.style.strokeDashoffset = offset;
                        text.innerText = progress;

                        // If completed, the form will redirect automatically
                        // Keep polling until redirected
                        if (data.status !== 'completed') {
                            setTimeout(pollProgress, 500);
                        }
                    })
                    .catch(() => {
                        // On error, retry after delay
                        setTimeout(pollProgress, 1000);
                    });
            };

            // Start polling after a short delay to let the form submit
            setTimeout(pollProgress, 1000);
        };

        // Handle Confidence Slider
        const confidenceSlider = document.getElementById('confidenceSlider');
        const confidenceInput = document.getElementById('confidenceInput');
        const confidenceValue = document.querySelector('.value-confidence');

        if (confidenceSlider && confidenceInput && confidenceValue) {
            confidenceSlider.addEventListener('input', (e) => {
                confidenceValue.innerText = `${e.target.value}%`;
                confidenceInput.value = e.target.value;
            });
        }

        // Handle Model Selection
        const modelSelect = document.getElementById('modelSelect');
        const modelInput = document.getElementById('modelInput');
        const selectedModelText = document.getElementById('selectedModelText');

        if (modelSelect && modelInput && selectedModelText) {
            modelSelect.addEventListener('change', (e) => {
                modelInput.value = e.target.value;
                // Update label (extract text in parenthesis)
                const text = e.target.options[e.target.selectedIndex].text;
                const match = text.match(/\((.*?)\)/);
                if (match) {
                    selectedModelText.innerText = match[1].split(' - ')[0]; // Just the size name
                }
            });
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('light')) {
                document.documentElement.classList.remove('light');
                localStorage.theme = 'dark';
            } else {
                document.documentElement.classList.add('light');
                localStorage.theme = 'light';
            }
        }

        // Advanced Settings Panel
        const advancedToggle = document.getElementById('advancedToggle');
        const advancedPanel = document.getElementById('advancedPanel');
        const advancedChevron = document.getElementById('advancedChevron');
        const trackerConfigInput = document.getElementById('trackerConfigInput');

        // Slider elements
        const trackHighThresh = document.getElementById('trackHighThresh');
        const trackLowThresh = document.getElementById('trackLowThresh');
        const matchThresh = document.getElementById('matchThresh');
        const trackBuffer = document.getElementById('trackBuffer');

        // Value display elements
        const valueHighThresh = document.querySelector('.value-high-thresh');
        const valueLowThresh = document.querySelector('.value-low-thresh');
        const valueMatchThresh = document.querySelector('.value-match-thresh');
        const valueTrackBuffer = document.querySelector('.value-track-buffer');

        // Default values
        const defaults = {
            track_high_thresh: 0.45,
            track_low_thresh: 0.1,
            match_thresh: 0.8,
            track_buffer: 30
        };

        // Toggle panel visibility
        if (advancedToggle && advancedPanel) {
            advancedToggle.addEventListener('click', () => {
                advancedPanel.classList.toggle('hidden');
                advancedChevron.style.transform = advancedPanel.classList.contains('hidden') ? '' : 'rotate(180deg)';
            });
        }

        // Update tracker config from sliders
        function updateTrackerConfig() {
            const config = {
                track_high_thresh: parseFloat(trackHighThresh.value) / 100,
                track_low_thresh: parseFloat(trackLowThresh.value) / 100,
                match_thresh: parseFloat(matchThresh.value) / 100,
                track_buffer: parseInt(trackBuffer.value)
            };
            trackerConfigInput.value = JSON.stringify(config);
        }

        // Slider event handlers
        if (trackHighThresh) {
            trackHighThresh.addEventListener('input', (e) => {
                valueHighThresh.innerText = (e.target.value / 100).toFixed(2);
                updateTrackerConfig();
            });
        }

        if (trackLowThresh) {
            trackLowThresh.addEventListener('input', (e) => {
                valueLowThresh.innerText = (e.target.value / 100).toFixed(2);
                updateTrackerConfig();
            });
        }

        if (matchThresh) {
            matchThresh.addEventListener('input', (e) => {
                valueMatchThresh.innerText = (e.target.value / 100).toFixed(2);
                updateTrackerConfig();
            });
        }

        if (trackBuffer) {
            trackBuffer.addEventListener('input', (e) => {
                valueTrackBuffer.innerText = e.target.value;
                updateTrackerConfig();
            });
        }

        // Reset to defaults
        const resetAdvanced = document.getElementById('resetAdvanced');
        if (resetAdvanced) {
            resetAdvanced.addEventListener('click', () => {
                trackHighThresh.value = defaults.track_high_thresh * 100;
                trackLowThresh.value = defaults.track_low_thresh * 100;
                matchThresh.value = defaults.match_thresh * 100;
                trackBuffer.value = defaults.track_buffer;

                valueHighThresh.innerText = defaults.track_high_thresh.toFixed(2);
                valueLowThresh.innerText = defaults.track_low_thresh.toFixed(2);
                valueMatchThresh.innerText = defaults.match_thresh.toFixed(2);
                valueTrackBuffer.innerText = defaults.track_buffer;

                updateTrackerConfig();
            });
        }
    </script>

</body>

</html>